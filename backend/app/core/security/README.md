# Authentication Service Architecture

This document describes the flexible authentication architecture implemented as part of Phase 2 of the SaaS Factory Blueprint.

## Overview

The authentication service is designed to support multiple authentication providers while maintaining a consistent interface for the rest of the application. This allows for seamless transition between different auth providers (like JWT and Supabase) without affecting the application's core functionality.

## Components

### 1. Auth Provider Interface (BaseAuthProvider)

An abstract base class that defines the interface for authentication providers. Any auth provider must implement:
- `validate_token`: Validates a token and returns the payload
- `get_user_info`: Extracts user information from a token
- `provider_name`: Returns the name of the provider

### 2. JWT Auth Provider (JWTAuthProvider)

The default authentication provider using JWT tokens generated by the application itself. It:
- Validates tokens using the application's secret key
- Extracts user information from the JWT payload
- Uses email as the primary user identifier

### 3. Auth Service

A service that manages multiple auth providers and presents a unified interface to the application. It:
- Maintains a registry of available auth providers
- Can validate tokens against multiple providers
- Supports hints to prioritize specific providers
- Provides graceful fallback when a provider fails

### 4. Middleware (AuthMiddleware)

A FastAPI middleware that handles authentication for all requests. It:
- Extracts tokens from request headers
- Validates tokens using the auth service
- Fetches the corresponding user from the database
- Sets the user in the request state for future use

### 5. Tenant Middleware (TenantMiddleware)

A FastAPI middleware that handles tenant isolation. It:
- Extracts tenant ID from headers or the authenticated user
- Sets tenant context in the database session
- Stores tenant ID in the request state

### 6. Dependencies

FastAPI dependencies that provide authorized users to route handlers:
- `get_current_user`: Returns the authenticated user
- `get_admin_user`: Returns the user if they're an admin
- `get_tenant_id`: Returns the current tenant ID
- `set_tenant_context`: Sets the tenant context in the database

## Usage

### Registering New Providers

To add a new authentication provider:

1. Implement the `BaseAuthProvider` interface:
   ```python
   class NewProvider(BaseAuthProvider):
       @property
       def provider_name(self) -> str:
           return "new_provider"
           
       async def validate_token(self, token: str) -> Dict[str, Any]:
           # Implementation here
           
       async def get_user_info(self, token: str) -> Dict[str, Any]:
           # Implementation here
   ```

2. Register it with the auth service:
   ```python
   from app.core.security.auth import auth_service
   
   auth_service.register_provider(NewProvider())
   ```

### Using the Auth Service

The auth service can be used directly:

```python
from app.core.security.auth import auth_service

# Validate a token
payload = await auth_service.validate_token(token)

# Get user info from a token
user_info = await auth_service.get_user_info(token)

# Specify a provider hint
user_info = await auth_service.get_user_info(token, provider_hint="jwt")
```

But most often, it will be used indirectly through FastAPI dependencies:

```python
from fastapi import Depends
from app.core.dependencies import get_current_user
from app.features.users.models import User

@app.get("/protected")
async def protected_route(current_user: User = Depends(get_current_user)):
    return {"message": f"Hello, {current_user.email}!"}
```

## Future Enhancements

As part of subsequent development phases, we plan to:

1. Implement a Supabase Auth provider
2. Add user mapping for external auth providers
3. Implement token refresh functionality
4. Support social login integrations